import { Coord } from './game';

export type LevelData = {
  id: string;
  colsLen: number;
  rowsLen: number;
  startY: number;
  endY: number;
  pointCoords: Coord[];
  edgesEndpointCoords: [Coord, Coord][];
};

export class LevelUtil {
  /**
   * 将关卡数据转为关卡字符串
   * @param levelData
   */
  static dataToString(levelData: LevelData) {
    const sortCord = (a: Coord, b: Coord) => {
      if (a.y === b.y) {
        return a.x - b.x;
      }
      return a.y - b.y;
    };
    const numToString = (num: number) => ('' + num).padStart(2, '0');
    levelData.pointCoords.sort(sortCord);
    levelData.edgesEndpointCoords.sort((a, b) => sortCord(a[0], b[0]));
    return [
      numToString(levelData.rowsLen) + numToString(levelData.colsLen),
      // levelData.startY + '' + levelData.endY,
      numToString(levelData.startY) + numToString(levelData.endY),
      levelData.pointCoords.reduce((before, current) => {
        return before + numToString(current.x) + numToString(current.y);
      }, ''),
      levelData.edgesEndpointCoords.reduce((before, current) => {
        return (
          before +
          numToString(current[0].x) +
          numToString(current[0].y) +
          numToString(current[1].x) +
          numToString(current[1].y)
        );
      }, ''),
    ].join('====');
  }
  /**
   * 根据关卡字符串生成关卡
   * @param levelString
   * @returns
   */
  static stringToData(levelString: string, id: string): LevelData {
    const [rowsAndColsLen, startAndEndY, pointCoordsString, edgesEndpointCoordsString] =
      levelString.split('====');
    const rowsLen = Number(rowsAndColsLen.slice(0, 2));
    const colsLen = Number(rowsAndColsLen.slice(2, 4));

    const startY = Number(startAndEndY.slice(0, 2));
    const endY = Number(startAndEndY.slice(2, 4));

    const pointCoords = pointCoordsString.split('').reduce((before, current, index) => {
      if (index % 4 === 3) {
        before.push({
          x: Number(pointCoordsString.slice(index - 3, index - 1)),
          y: Number(pointCoordsString.slice(index - 1, index + 1)),
        });
      }
      return before;
    }, [] as Coord[]);

    const edgesEndpointCoords = edgesEndpointCoordsString
      .split('')
      .reduce((before, current, index) => {
        if (index % 8 === 7) {
          before.push([
            {
              x: Number(edgesEndpointCoordsString.slice(index - 7, index - 5)),
              y: Number(edgesEndpointCoordsString.slice(index - 5, index - 3)),
            },
            {
              x: Number(edgesEndpointCoordsString.slice(index - 3, index - 1)),
              y: Number(edgesEndpointCoordsString.slice(index - 1, index + 1)),
            },
          ]);
        }
        return before;
      }, [] as [Coord, Coord][]);
    const firstActiveEdgeIndex = edgesEndpointCoords.findIndex((endpointCoords) => {
      return endpointCoords[0].x === -1 || endpointCoords[1].x === -1;
    });
    edgesEndpointCoords.unshift(edgesEndpointCoords.splice(firstActiveEdgeIndex, 1)[0]);
    return {
      id,
      colsLen,
      rowsLen,
      startY,
      endY,
      pointCoords,
      edgesEndpointCoords,
    };
  }
}

const systemLevelMap = {
  clickmazes1:
    '0606====0303====040005000001010102020302000305030304040401050205====000100030001010102020205-10300030105010101050205',
  clickmazes2:
    '0606====0002====020005000101040100020202030202030403010405040005====-10002000500050401010104040104030002000502020203',
  clickmazes3:
    '0606====0404====00000200050001010301040105020003040302040304010504050505====05000502-104020402040200',
  clickmazes4:
    '0606====0004====010002000400030105010102040200030203050300040304010503050405====-10001000102040201050305',
  clickmazes5:
    '0606====0505====000002000500010103010202040201030004030405040205====050005040101010302020402-1050205',
  clickmazes6:
    '0606====0204====0000020005000101040103020502000304030204010503050505====01010401-10203020302030501050305',
  clickmazes7:
    '0606====0200====000002000101040102020502000303030204040401050505====0000020001010401-10202020204040401050505',
  clickmazes8:
    '0606====0505====00000100030002010401050101020402000301030303050302040404000502050505====01000300-105000500050205',
  clickmazes9:
    '0606====0405====00000100020005000101040100020502000302030403010404040005010503050505====0101010400020003-104010401040404',
  clickmazes10:
    '0606====0302====00000100050000010201040102020103040301040504020504050505====00000001010001030201020204010403-103010301040504',
  clickmazes11:
    '0606====0104====00000100040001010301000202020502030304030204000501050505====04000403-101010101010105030103030502050503030403',
  clickmazes12:
    '0606====0202====01000500000104010202030201030403010405040005020504050505====0100050000010401-1020202040304050504050500050205',
  clickmazes13:
    '0606====0103====000002000300050001010301000202020402010302030503000403040404000503050505====02000202-10101010103020300040005',
  clickmazes14:
    '0606====0304====000002000400050002010002030205020103020304030004020405040005010503050405====0200020103020305-1030103',
  clickmazes15:
    '0606====0403====010003000500000102010401010205020003030301040404000503050505====030003030001000304010404-104010400050305',
  clickmazes16:
    '0606====0302====00000100020003000500020105010002030204020203010405040005010502050405====0000010002010203-10302030104050402050405',
  clickmazes17:
    '0606====0304====00000100030004000101050100020202050202030403050303040005010502050505====03000304-10302030203020504030503',
  clickmazes18:
    '0606====0201====05000301040100020202050200030103030302040404050400050305====0500050203010303-10200020002020203030305',
  clickmazes19:
    '0606====0002====02000500010103010401000201020402000303030503010402040404010504050505====-1000200000200030503050502040404',
  random1:
    '0606====0104====010103010401050100020202030204030204030400050305====-1010101030103020401040300020005',
  random2:
    '0606====0301====0000010002000001020103010401000301030504000502050305====01000103020002010001000303010305-1030003',
  random3:
    '0606====0502====02000400050004010002020203020103010404040005010502050305====040104040002000501030104-1050005',
  random4:
    '0606====0104====00000200050001010201040104020103030305030404000503050505====0200020105000503-10101010402040403030305',
  random5:
    '0606====0500====040003010302040201030303040305030004050403050505====030103020303030505040505-1050305',
  random6:
    '0606====0502====040003010302040201030303040305030004050403050505====030103020303030505040505-1050305',
  random7:
    '0606====0003====000001000200030000010301040105010002030204030204030403050505====-1000000030003010401040305010505',
  random8:
    '0606====0305====03000500000101010201030105010003010402040304000501050405====0001000303010304-1030003',
  random9:
    '0606====0100====010002000300010103010401030201030203030302040404050401050305====-1010101040104040302030303030305',
  random10:
    '0606====0103====010002000300010103010401030201030203030302040404050401050305====-1010101040104040302030303030305',
  random11:
    '0606====0200====000001000500010103010501000202020003010304030503020400050305====01010103-102000202020204',
  random12:
    '0606====0201====000001000500010103010501000202020003010304030503020400050305====01010103-102000202020204',
  random13:
    '0606====0203====000001000500010103010501000202020003010304030503020400050305====01010103-102000202020204',
  random14:
    '0606====0102====0500030105010402000303030403000404040504000501050205====05000501-1010301030103030501050400040005',
  random15:
    '0606====0404====02000300050003010401010204020502050300040104020402050505====0200020405030505-1040004',
  random16:
    '0606====0401====000001000200040005000301050100020003040300040304040402050305====000000020200020504030404-1040004',
  random17:
    '0606====0003====000000010201040103020402050201030303020405040005010502050305====-100000000010005020102040302030305020504',
  random18:
    '0606====0404====000001000500020105010302040205020203030304030004020404050505====00000004050005010203020404030405-1040004',
  random19:
    '0606====0200====020003000400040103020003010302030403010403040504000502050405====0300030204010403-10203020003000501030104',
  random20:
    '0606====0304====010002000400000101010301050101020202050200030303040305030404====020002020001000305010502-103000304030404',
  random21:
    '0606====0204====00000200030004000301030204020203040300040304050401050205====03010302-1020302030203040402040302030205',
  random22:
    '0606====0301====01000400050000010101030104010102030201030104050400050105====040004010500050401020103-1030103',
  random23:
    '0606====0502====000004000001010101020202030205020003020302040404000501050205====040004040001000302040205-1050005',
  random24:
    '0606====0201====000004000500000101010201000202020402020403040504000501050305====05000504-10200020202020403040305',
  random25:
    '0606====0201====00000100020000010301040100020202030204020003010300050405====010001030200020204010402-1020002',
  random26:
    '0606====0205====00000100020000010301040100020202030204020003010300050405====010001030200020204010402-1020002',
} as {
  [key: string]: string;
};

export const systemLevels = Object.keys(systemLevelMap).map((id) => {
  return LevelUtil.stringToData(systemLevelMap[id], id);
});
